DROP VIEW IF EXISTS vw_detalle_ventas_diarias;
DROP PROCEDURE IF EXISTS sp_obtener_ventas_vendedor;

CREATE VIEW vw_detalle_ventas_diarias AS
SELECT 
    v.Nombre AS Vendedor,
    c.DNI AS DNI_Cliente,
    CONCAT(c.Nombre, ' ', c.Apellido_Pat) AS Cliente,
    s.Fecha_Venta,
    s.Tipo_de_Pago,
    GROUP_CONCAT(
        CONCAT(m.Nombre, ' (', ds.Cantidad, ')')
        SEPARATOR ', '
    ) AS Detalle_Productos,
    s.Monto_Total,
    s.ID AS Numero_Venta
FROM 
    Salida s
    INNER JOIN Vendedor v ON s.Vendedor_ID = v.ID
    INNER JOIN Cliente c ON s.Cliente_ID = c.ID
    INNER JOIN Detalle_Salida ds ON s.ID = ds.Salida_ID
    INNER JOIN Medicamento m ON ds.Medicamento_ID = m.ID
GROUP BY 
    s.ID, v.Nombre, c.DNI, c.Nombre, c.Apellido_Pat,
    s.Fecha_Venta, s.Tipo_de_Pago, s.Monto_Total;

DELIMITER //

CREATE PROCEDURE sp_obtener_ventas_vendedor(
    IN p_vendedor_id INT,
    IN p_fecha DATE
)
BEGIN
    SELECT 
        v.Nombre AS Vendedor,
        c.DNI AS DNI_Cliente,
        CONCAT(c.Nombre, ' ', c.Apellido_Pat) AS Cliente,
        s.Fecha_Venta,
        s.Tipo_de_Pago,
        GROUP_CONCAT(
            CONCAT(m.Nombre, ' (', ds.Cantidad, ')')
            SEPARATOR ', '
        ) AS Detalle_Productos,
        s.Monto_Total,
        s.ID AS Numero_Venta
    FROM 
        Salida s
        INNER JOIN Vendedor v ON s.Vendedor_ID = v.ID
        INNER JOIN Cliente c ON s.Cliente_ID = c.ID
        INNER JOIN Detalle_Salida ds ON s.ID = ds.Salida_ID
        INNER JOIN Medicamento m ON ds.Medicamento_ID = m.ID
    WHERE 
        v.ID = p_vendedor_id 
        AND s.Fecha_Venta = p_fecha
    GROUP BY 
        s.ID, v.Nombre, c.DNI, c.Nombre, c.Apellido_Pat,
        s.Fecha_Venta, s.Tipo_de_Pago, s.Monto_Total;
END //

DELIMITER ;
SELECT * FROM vw_detalle_ventas_diarias;
CALL sp_obtener_ventas_vendedor(1, '2024-12-16');



-- Primero borramos si existen
DROP VIEW IF EXISTS vw_reporte_caja;
DROP PROCEDURE IF EXISTS sp_reporte_caja_vendedor;

-- Vista general de todas las cajas
CREATE VIEW vw_reporte_caja AS
SELECT 
    v.Nombre AS Vendedor,
    c.Fecha,
    c.Saldo_Final
FROM 
    Caja c
    INNER JOIN Vendedor v ON c.Vendedor_ID = v.ID
ORDER BY 
    c.Fecha DESC;

-- Procedimiento para buscar por vendedor y fecha específica
DELIMITER //

CREATE PROCEDURE sp_reporte_caja_vendedor(
    IN p_vendedor_id INT,
    IN p_fecha DATE
)
BEGIN
    SELECT 
        v.Nombre AS Vendedor,
        c.Fecha,
        c.Saldo_Final
    FROM 
        Caja c
        INNER JOIN Vendedor v ON c.Vendedor_ID = v.ID
    WHERE 
        v.ID = p_vendedor_id 
        AND c.Fecha = p_fecha;
END //

DELIMITER ;

-- Ver todas las cajas
SELECT * FROM vw_reporte_caja;

-- Ver caja específica por vendedor y fecha
CALL sp_reporte_caja_vendedor(2, '2024-12-16');
CALL sp_reporte_caja_vendedor(1, '2024-12-16');




DROP PROCEDURE IF EXISTS sp_reporte_cajas_fecha;

DELIMITER //

CREATE PROCEDURE sp_reporte_cajas_fecha(
    IN p_fecha DATE
)
BEGIN
    SELECT 
        v.ID AS Vendedor_ID,
        v.Nombre AS Vendedor,
        c.Fecha,
        c.Saldo_Final
    FROM 
        Caja c
        INNER JOIN Vendedor v ON c.Vendedor_ID = v.ID
    WHERE 
        c.Fecha = p_fecha
    ORDER BY 
        v.Nombre ASC;
END //

DELIMITER ;

CALL sp_reporte_cajas_fecha('2024-12-16');










DROP VIEW IF EXISTS vista_reporte_compras;
DROP VIEW IF EXISTS vista_reporte_compras_semana;
DROP VIEW IF EXISTS vista_reporte_compras_mes;


-- Vista general de compras con medicamentos agrupados
CREATE OR REPLACE VIEW vista_reporte_compras AS
SELECT 
    GROUP_CONCAT(m.Nombre SEPARATOR ', ') as Medicamentos,
    l.Nombre as Laboratorio,
    e.Fecha_Entrega,
    SUM(de.Cantidad) as Cantidad_Total,
    GROUP_CONCAT(CONCAT(m.Nombre, ': ', de.Cantidad) SEPARATOR ', ') as Detalle_Cantidades,
    e.Total,
    e.ID as Entrada_ID
FROM Medicamento as m
JOIN Detalle_Entrada as de ON m.ID = de.Medicamento_ID
JOIN Entrada as e ON de.Entrada_ID = e.ID
JOIN Laboratorio as l ON e.Laboratorio_ID = l.ID
GROUP BY e.ID, l.Nombre, e.Fecha_Entrega, e.Total
ORDER BY e.Fecha_Entrega DESC;

-- Vista para los últimos 7 días
CREATE OR REPLACE VIEW vista_reporte_compras_semana AS
SELECT 
    GROUP_CONCAT(m.Nombre SEPARATOR ', ') as Medicamentos,
    l.Nombre as Laboratorio,
    e.Fecha_Entrega,
    SUM(de.Cantidad) as Cantidad_Total,
    GROUP_CONCAT(CONCAT(m.Nombre, ': ', de.Cantidad) SEPARATOR ', ') as Detalle_Cantidades,
    e.Total,
    e.ID as Entrada_ID
FROM Medicamento as m
JOIN Detalle_Entrada as de ON m.ID = de.Medicamento_ID
JOIN Entrada as e ON de.Entrada_ID = e.ID
JOIN Laboratorio as l ON e.Laboratorio_ID = l.ID
WHERE e.Fecha_Entrega >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY e.ID, l.Nombre, e.Fecha_Entrega, e.Total
ORDER BY e.Fecha_Entrega DESC;

-- Vista para el último mes
CREATE OR REPLACE VIEW vista_reporte_compras_mes AS
SELECT 
    GROUP_CONCAT(m.Nombre SEPARATOR ', ') as Medicamentos,
    l.Nombre as Laboratorio,
    e.Fecha_Entrega,
    SUM(de.Cantidad) as Cantidad_Total,
    GROUP_CONCAT(CONCAT(m.Nombre, ': ', de.Cantidad) SEPARATOR ', ') as Detalle_Cantidades,
    e.Total,
    e.ID as Entrada_ID
FROM Medicamento as m
JOIN Detalle_Entrada as de ON m.ID = de.Medicamento_ID
JOIN Entrada as e ON de.Entrada_ID = e.ID
JOIN Laboratorio as l ON e.Laboratorio_ID = l.ID
WHERE e.Fecha_Entrega >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
GROUP BY e.ID, l.Nombre, e.Fecha_Entrega, e.Total
ORDER BY e.Fecha_Entrega DESC;


SELECT * FROM vista_reporte_compras;
SELECT * FROM vista_reporte_compras_semana;
SELECT * FROM vista_reporte_compras_mes;